<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClockWork</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e; 
            color: #e0e0e0; 
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        header {
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
        }
        main {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #2b2b2b;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        #playlist-container {
            margin-top: 10px;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
        }
        #playlist-box {
            background-color: #2b2b2b;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-left: 30px;
        }
         #music-player{
            background-color: #2b2b2b;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 250px;
            display: none;
            flex-direction: column;
            align-items: center;
            margin-left: -290px;
            margin-top: 500px;

        } 
        .container {
            display: flex;
            gap: 20px;
        }
        #timer {
            font-size: 4rem;
            color: #e0e0e0;
            background-color: #333;
            border: 5px solid #4a90e2;
            border-radius: 10px;
            padding: 20px;
            width: 150px;
            margin: 20px 0;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }
        input, button {
            padding: 12px 20px;
            font-size: 16px;
            margin: 10px;
            border: 2px solid #4a90e2;
            border-radius: 5px;
            background-color: #444;
            color: #e0e0e0;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        button {
            cursor: pointer;
        }
        button:hover {
            background-color: #4a90e2;
            color: white;
        }
        button:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <header>
        <h1>ClockWork</h1>
    </header>

    <div class="user-info">
        {% if user_name %}
            <p>Welcome, {{ user_name }}</p>
        {% else %}
            <a href="/login"><button>Login with Spotify</button></a>
        {% endif %}
    </div>
    <div class="container">
        <main>
            <h2>Start Your Pomodoro Session</h2>
            <label for="userName">Name:</label>
            <input type="text" id="userName" placeholder="Your name" required>

            <label for="userEmail">Email:</label>
            <input type="email" id="userEmail" placeholder="Your email" required>

            <label for="workTime">Work Time (minutes):</label>
            <input type="number" id="workTime" value="25" min="0">
            
            <label for="breakTime">Break Time (minutes):</label>
            <input type="number" id="breakTime" value="5" min="0">

            <div id="timer">25:00</div>
            <button id="startBtn">Start</button>
            <button id="resetBtn">Reset</button>
        </main>
    </div>

    {% if user_name %}

    <div id="playlist-box">
        <h3>Select a Study Playlist:</h3>
        <button id="loadPlaylistsBtn">Load Playlists</button>
        <div id="playlist-container"></div>
    </div>

    <div id="music-player">
        <img src="/static/play.png" width="50" height="50" id = "controller" name="play" onclick="clicky()"/>
          
    </div>

    {% endif %}

    <script>

        var currUri;
        var uriChange = 0;

        function clicky(){
            uri = currUri;
            if(document.getElementById("controller").name == "play"){

                if(uriChange == 0){
                    fetch('/resume_music', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            }).then(response => response.json())
                            .then(data => console.log(data.message));
                    
                }
                else{
                fetch('/play_music', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ uri })
                            }).then(response => response.json())
                            .then(data => console.log(data.message));
                            uriChange = 0;
                        }

                document.getElementById("controller").src = "/static/pause.png";
                document.getElementById("controller").name = "pause";
            }
            else{
                fetch('/pause_music', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                            }).then(response => response.json())
                            .then(data => console.log(data.message));
                document.getElementById("controller").src = "/static/play.png";
                document.getElementById("controller").name = "play";
            }
        }


        function openWindow( url )
        {
            window.open( 'https://open.spotify.com/');
            window.focus();
        }


        document.getElementById('loadPlaylistsBtn').addEventListener('click', () => {
            openWindow();
            fetch('/get_playlists')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('playlist-container');
                    container.innerHTML = '';
                    data.forEach(playlist => {
                        const btn = document.createElement('BUTTON');
                        btn.style = "border: 0.5px solid #FFFFFF";
                        btn.textContent = playlist.name;
                        btn.uri = playlist.uri;
                        btn.addEventListener('click', function(){
                            uri = btn.uri;
                            currUri = uri;
                            uriChange = 1;
                            var buttonList = document.getElementById('playlist-container').querySelectorAll('BUTTON');
                            buttonList.forEach(button => {
                                button.style = "background-color: #444; border: 0.5px solid #FFFFFF";
                            });
                            btn.style = "background-color: #4a90e2";
                            document.getElementById('music-player').style.display = "flex";
                         

                        });
                        container.appendChild(btn);
                        container.appendChild(document.createElement('br'));

                    });
                })
                .catch(error => console.error('Error fetching playlists:', error));
        });



    </script>

    <script>
        let timeLeft;
        let timerId;
        let isRunning = false;
        let isWorkSession = true;

        const timerElement = document.getElementById('timer');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const workTimeInput = document.getElementById('workTime');
        const breakTimeInput = document.getElementById('breakTime');

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function startTimer() {
            if (!isRunning) {
                const userName = document.getElementById('userName').value;
                const userEmail = document.getElementById('userEmail').value;
                let workTime = parseInt(workTimeInput.value) * 60;
                let breakTime = parseInt(breakTimeInput.value) * 60;

                if (isWorkSession) {
                    timeLeft = workTime;
                } else {
                    timeLeft = breakTime;
                }
                updateTimerDisplay();

                isRunning = true;
                startBtn.textContent = 'Pause';

                timerId = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        updateTimerDisplay();
                    } else {
                        clearInterval(timerId);
                        isRunning = false;
                        startBtn.textContent = 'Start';

                        if (isWorkSession) {
                            alert('Work session complete! Time for a break.');
                        } else {
                            alert('Break over! Time to get back to work.');
                        }
                        isWorkSession = !isWorkSession;
                    }
                }, 1000);

                fetch('/start_pomodoro', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userName, userEmail, workTime: workTime / 60, breakTime: breakTime / 60 })
                }).then(response => response.json())
                  .then(data => console.log(data.message));

            } else {
                clearInterval(timerId);
                isRunning = false;
                startBtn.textContent = 'Start';
            }
        }

        function resetTimer() {
            clearInterval(timerId);
            isRunning = false;
            isWorkSession = true;
            startBtn.textContent = 'Start';
            timerElement.textContent = `${workTimeInput.value}:00`;
        }

        startBtn.addEventListener('click', startTimer);
        resetBtn.addEventListener('click', resetTimer);

        workTimeInput.addEventListener('input', () => {
            if (!isRunning && isWorkSession) {
                timerElement.textContent = `${workTimeInput.value}:00`;
            }
        });
    </script>
</body>
</html>
